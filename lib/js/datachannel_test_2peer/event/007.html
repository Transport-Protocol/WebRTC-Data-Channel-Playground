<!DOCTYPE html>
<html lang="en" class="a">
	<head>
		<meta charset="utf-8">
		<!-- Testharness Timeout to long -> 60 Seconds-->
		<meta name="timeout" content="long">
		<title>WebRTC - Send Test</title>
		<script src="../resources/testharness.js"></script>
		<script src="../resources/testharnessreport.js"></script><link href="../resources/testharness.css" type="text/css" rel="stylesheet"/>
		<!-- Including the Firebase.js to send the ICE Candidate to the other peer-->
		<script type="text/javascript" src='https://cdn.firebase.com/v0/firebase.js'></script>
	</head>
	<body class="a">
		<div>
			<div id="signallingInfo"></div>
			
				
			
		</div>
		<hr />

		<!-- Testharness log -->
		<div id="log"></div>
		<script src="../datachannel2peers.js" type="text/javascript"></script>
		<script type="text/javascript">
            var label = "test";
            var dataChannel = null, dataChannel2 = null;
            var readyStates = "";
            var missed = false;
            var values = ["connecting", "open", "closing", "closed"];
            var test = async_test("Create 2 associated DataChannels: Attribute - readyState - RTCDataChannelState - readonly - check for available states 'open', 'connecting', 'closing', 'closed'");
            if (offerer) {
                test.step(function() {
                    dataChannel = peerConnection.createDataChannel(label);
                    readyStates += dataChannel.readyState;
                    
                    dataChannel.onopen = test.step_func(function() {
                        readyStates += dataChannel.readyState;
                        dataChannel.close();
                        readyStates += dataChannel.readyState;
                    });
                    
                    peerConnection.ondatachannel = test.step_func(function(e) {
                    	dataChannel2 = e.channel;
                    	readyStates += dataChannel2.readyState + dataChannel.readyState;
                    	dataChannel2.onclose = test.step_func(function(){
                    		console.log("onclose");
                    		readyStates += dataChannel2.readyState + dataChannel.readyState;		
                    	});
                    	
                    	setTimeout(test.step_func(function(){
                    		for(var i = 0; i< values.length; i++){        
						        if(readyStates.search(values[i]) == -1){
						            missed = " '" +values[i]+"'";
						        }        
						    }
						    if(missed){
						    	assert_unreached("Missed readySate: " + missed);
						    }
						    test.done();
                    	}), 2000);
                    });
                });
            } else {
				test.step(function() {
                    dataChannel = peerConnection.createDataChannel(label);
                    readyStates += dataChannel.readyState;
                    
                    dataChannel.onopen = test.step_func(function() {
                        readyStates += dataChannel.readyState;
                        dataChannel.close();
                        readyStates += dataChannel.readyState;
                    });
                    
                    peerConnection.ondatachannel = test.step_func(function(e) {
                    	dataChannel2 = e.channel;
                    	readyStates += dataChannel2.readyState + dataChannel.readyState;
                    	dataChannel2.onclose = test.step_func(function(){
                    		console.log("onclose");
                    		readyStates += dataChannel2.readyState + dataChannel.readyState;		
                    	});
                    	
                    	setTimeout(test.step_func(function(){
                    		for(var i = 0; i< values.length; i++){        
						        if(readyStates.search(values[i]) == -1){
						            missed = " '" +values[i]+"'";
						        }        
						    }
						    if(missed){
						    	assert_unreached("Missed readySate: " + missed);
						    }
						    test.done();
                    	}), 2000);
                    });
                });
            }
		</script>
	</body>
</html>

